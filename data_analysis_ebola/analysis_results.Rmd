---
title: "Ebola Analysis Results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


# load libraries
library(ggplot2)
library(grid)
library(gridExtra)
library(nimble)
library(plyr)
library(dplyr)
library(knitr)
library(kableExtra)
library(ggh4x)

# for movingAverage function
source('./scripts/modelCodes.R')
```

## Ebola Data

From outbreaks::ebola_kikwit_1995. Contain new cases of Ebola in Kikwit, DRC.

Over the entire period, there were 316 cases. Symptom onset is known for 291 cases
and death date is known for 236 people. Recovery times for individuals that did not
die are not reported.

```{r}
dat <- read.csv('./data/ebolaClean.csv')
dat$date <- as.Date(dat$date)

plot(dat$date, dat$onset, type= 'l', ylab = 'Count', xlab = 'Date')
lines(dat$date, dat$death, col = 'red')
legend('topright', c('cases', 'deaths'), col = c('black', 'red'), lwd = 5, cex = 1.5, bty = 'n')


```

## Model

Ebola is best modeled with an SEIR structure as there is a latent period of around 6-7 days 
after exposure before individuals become infectious.


\begin{align*}
E_t^* &\sim Binom\left(S_t, \pi_t^{(SE)}\right) \\
I_t^* &\sim Binom\left(E_t, \pi^{EI}\right) \\
R_t^* &\sim Binom\left(I_t, \pi^{(IR)}\right) \\
\end{align*}

Transition probabilities are modeled as:

\begin{align*}
\pi_t^{(SE)} &= 1 - \exp\left\{\beta(1 - a_t) \frac{I_t}{N}\right\} \\
\pi^{(EI)} &= 1 - \exp\left(-\gamma_E\right) \\
\pi^{(IR)} &= 1 - \exp\left(-\gamma_I\right) \\
\end{align*}

$I_t^*$ and $R_t^*$ are partially observed, $E_t^*$ is fully latent. The missing
components are estimated with the MCMC process.

Various alarm functions were considered:

* Power
* Threshold
* Hill
* Spline
* GP
* No alarm, only $\beta_t$ estimated with splines
* No alarm, $\beta_t = \beta$

Alarms were informed by cumulative incidence, as the epidemic was completely observed.

## Results

```{r}
grAll <- readRDS('./results/grAll.rds')
alarmPostAll <- readRDS('./results/alarmPostAll.rds')
paramsPostAll <- readRDS('./results/paramsPostAll.rds')
R0PostAll <- readRDS('./results/R0PostAll.rds')
compsPostAll <- readRDS('./results/compsPostAll.rds')
waicAll <- readRDS('./results/waicAll.rds')
postPredFitAll <- readRDS('./results/postPredFitAll.rds')
```

### Alarm function estimation

```{r}
ggplot(alarmPostAll, aes(x = xAlarm, y = mean, ymin = lower, ymax = upper)) +
    facet_grid(~alarmFit) +
    geom_line() + 
    geom_ribbon(alpha = 0.3) + 
    theme_bw()
```

### Reproductive number estimation

The Ebola virus was confirmed as the causative agent on May 9 when tests were carried out on specimens collected from some of the early cases. Control measures were immediately introduced. These included, among others, the use of protective clothing, active surveillance, and community education.

Previous modeling of this epidemic has included a change point in transmission on May 9. 
Our results indicate that behavior change started to occur prior to this point.

```{r, fig.width=10}

# get the actual date 
timeDat <- dat
timeDat$time <- 1:nrow(dat)

R0PostAll <- merge(R0PostAll, timeDat, by = c('time'), all.x = T)


ggplot(subset(R0PostAll, alarmFit != 'betatSpline'), 
       aes(x = date, y = mean, ymin = lower, ymax = upper)) +
    facet_grid(~alarmFit) +
    geom_line() + 
    geom_ribbon(alpha = 0.3) + 
    theme_bw() + 
    geom_vline(xintercept = as.Date('1995-05-09'), linetype = 2, col = 'red') + 
    geom_hline(yintercept = 1, linetype = 2)
```


### WAIC 

```{r}
waicAll[,c(2,1)] %>%
    kbl(row.names = F, format.args = list(big.mark = ",")) %>%
    kable_styling(full_width = F) %>%
    row_spec(2, background = "yellow")
```

### Posterior predictive fit

```{r, fig.width=10}

postPredFitAll <- merge(postPredFitAll, timeDat, by = c('time'), all.x = T)

ggplot(subset(postPredFitAll, alarmFit != 'betatSpline'),
       aes(x = date, y = mean, ymin = lower, ymax = upper)) +
    facet_grid(~alarmFit) +
    geom_line() + 
    geom_ribbon(alpha = 0.3) + 
    geom_line(aes(y = onset), col = 'red') +
    theme_bw() 
```

```{r}
# convert to cumulative sum
postPredFitAll <- postPredFitAll[order(postPredFitAll$alarmFit, 
                                       postPredFitAll$time),]


postPredFitAllCum <- postPredFitAll %>%
    group_by(alarmFit) %>%
    mutate(cumMean = cumsum(mean),
           cumLower = cumsum(lower),
           cumUpper = cumsum(upper),
           cumTruth = cumsum(onset)) %>%
    as.data.frame()

ggplot(subset(postPredFitAllCum, alarmFit != 'betatSpline'), 
       aes(x = date, y = cumMean, ymin = cumLower, ymax = cumUpper)) +
    facet_grid(~alarmFit) +
    geom_line() + 
    geom_ribbon(alpha = 0.3) + 
    geom_line(aes(y = cumTruth), col = 'red') +
    theme_bw() 

```


### Posterior distribution of compartments over time

$E^*$, $I^*$, $R^*$, are fully or partially estimated via MCMC.

Estimating the timing of 23 missing symptom onset times and ~80 missing removal times.

```{r, fig.width=10, fig.height =  8}
ggplot(subset(compsPostAll, alarmFit != 'betatSpline'), 
       aes(x = time, y = mean, ymin = lower, ymax = upper)) +
    facet_grid(comp~alarmFit) +
    geom_line() + 
    geom_ribbon(alpha = 0.3) + 
    geom_line(aes(y = obs), col = 'red') +
    theme_bw() 
```




### Posterior distribution of parameters

```{r}
options(knitr.kable.NA = '')

paramsPostAll$formattedCol <- paste0(round(paramsPostAll$mean, 2), " (",
                                     round(paramsPostAll$lower, 2), ', ',
                                     round(paramsPostAll$upper, 2), ')')

paramsPostAll$formattedCol[paramsPostAll$param == 'k'] <- 
    paste0(round(paramsPostAll$mean[paramsPostAll$param == 'k'], 5), " (",
           round(paramsPostAll$lower[paramsPostAll$param == 'k'], 5), ', ',
           round(paramsPostAll$upper[paramsPostAll$param == 'k'], 5), ')')

paramsPostAll$formattedCol[paramsPostAll$param == 'H'] <- 
    paste0(round(paramsPostAll$mean[paramsPostAll$param == 'H'] , 5), " (",
           round(paramsPostAll$lower[paramsPostAll$param == 'H'] , 5), ', ',
           round(paramsPostAll$upper[paramsPostAll$param == 'H'] , 5), ')')


# convert to wide format
paramsPostWide <- reshape(paramsPostAll[paramsPostAll$alarmFit != 'betatSpline' ,c(1,5,6)], 
                          timevar = "param",
                          idvar = "alarmFit",
                          direction = "wide")
colnames(paramsPostWide) <- gsub('formattedCol\\.', '', colnames(paramsPostWide))

paramsPostWide %>%
    kbl(row.names = F) %>%
    kable_styling()
```

