---
title: "BCM Simulation Results"
author: "Caitlin Ward"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 14, fig.height = 10)

library(openxlsx)
library(ggplot2)
library(grid)
library(gridExtra)
library(nimble)

# functions to calculate the alarms
source('./scripts/modelCodes.R')

theme_set(theme_bw() + 
    theme(strip.background = element_rect(fill = 'white'),
          strip.text = element_text(size = 16),
          axis.title = element_text(size = 16),
          axis.text = element_text(size = 14)))

```

## Gelman Rubin

```{r}
grAll <- readRDS('./resultsFinal/grAll.rds')

# which didn't converge
notConverge <- grAll[which(grAll$gr > 1.1),  ]
notConvergeModels <-  notConverge[!duplicated(notConverge),
                                  c('alarmGen', 'alarmFit',
                                    'infPeriod', 'smoothWindow', 'simNumber')]
notConvergeModels$noConverge <- 1


table(notConverge$alarmGen, notConverge$alarmFit, notConverge$smoothWindow)

```



## Posterior parameter estimates 

When correct parametric model was fit to the true data generation process.

```{r}
### load truth
paramsTruth <- read.xlsx('simParamsSummary.xlsx')
paramsTruth <- paramsTruth[paramsTruth$infPeriod == 'fixed',]

### wide to long
paramsTruth <- reshape(paramsTruth, 
  varying = c("beta", "delta", "H", "nu", "x0", "k"), 
  v.names = "truth",
  timevar = "param", 
  times = c("beta", "delta", "H", "nu", "x0", "k"), 
  new.row.names = 1:1000,
  direction = "long")

paramsTruth <- paramsTruth[-which(is.na(paramsTruth$truth)),]
paramsTruth <- paramsTruth[order(paramsTruth$alarmGen, paramsTruth$smoothWindow, paramsTruth$param),]
paramsTruth <- paramsTruth[-which(colnames(paramsTruth) %in% c('infPeriod', 'id'))]

paramsPostAll <- readRDS('./resultsFinal/paramsPostAll.rds')

# only keep rows where alarmGen == alarmFit
paramsPostAll <- paramsPostAll[paramsPostAll$alarmGen == paramsPostAll$alarmFit,]

# merge with truth
paramsPostAll <- merge(paramsPostAll, paramsTruth, by = c('param', 'alarmGen', 'smoothWindow'),
                       all.x = T)

paramsPostAll <- paramsPostAll[order(paramsPostAll$alarmGen, 
                                     paramsPostAll$smoothWindow,
                                     paramsPostAll$simNumber, 
                                     paramsPostAll$param),]


### create plot with posterior means and 95% credible intervals
```


### Threshold Alarm

```{r}
### threshold alarm
ggplot(data = subset(paramsPostAll, alarmFit == 'thresh'), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2) +
    facet_wrap(~param + smoothWindow, nrow = 2, scales = 'free_y',
               labeller = "label_both") +
    labs(x = 'Simulation Number', y = '') 


```

### Hill Alarm

```{r}
### hill alarm
ggplot(data = subset(paramsPostAll, alarmFit == 'hill'), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2) +
    facet_wrap(~param + smoothWindow, nrow = 2, scales = 'free_y',
               labeller = "label_both") +
    labs(x = 'Simulation Number', y = '')
```

### Power Alarm

```{r}
### power alarm
ggplot(data = subset(paramsPostAll, alarmFit == 'power'), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2) +
    facet_wrap(~param + smoothWindow, nrow = 2, scales = 'free_y',
               labeller = "label_both") + 
    labs(x = 'Simulation Number', y = '')
```



## Posterior for Alarm Function

```{r}
### get parameters for true alarms
paramsTruth <- read.xlsx('simParamsSummary.xlsx')
paramsTruth <- paramsTruth[paramsTruth$infPeriod == 'fixed',]

N <- 1e6

xAlarm <- 0:400
trueAlarmThresh14 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14)],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14)])
trueAlarmThresh30 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30)],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30)])
trueAlarmHill14 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14)],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14)],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14)])
trueAlarmHill30 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30)],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30)],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30)])
trueAlarmPower14 <- powerAlarm(xAlarm, N = N, 
                                k = paramsTruth$k[
                                    (paramsTruth$alarmGen == 'power' & 
                                         paramsTruth$smoothWindow == 14)])
trueAlarmPower30 <- powerAlarm(xAlarm, N = N, 
                                k = paramsTruth$k[
                                    (paramsTruth$alarmGen == 'power' & 
                                         paramsTruth$smoothWindow == 30)])

trueAlarms <- data.frame(xAlarm = rep(xAlarm, 6),
                               trueAlarm = c(trueAlarmThresh14,
                                             trueAlarmThresh30,
                                             trueAlarmHill14,
                                             trueAlarmHill30,
                                             trueAlarmPower14,
                                             trueAlarmPower30),
                               alarmGen = c(rep('thresh', length(xAlarm)*2),
                                            rep('hill', length(xAlarm)*2),
                                            rep('power', length(xAlarm)*2)),
                               smoothWindow = rep(rep(c(14, 30), each = length(xAlarm)), 3))

### load posterior estimates
alarmAll <- readRDS('./resultsFinal/alarmPostAll.rds')

alarmAll$alarmFit <- factor(alarmAll$alarmFit,
                            levels = c('spline', 'gp', 'thresh', 'hill', 'power'),
                            labels = c('Spline', 'Gaussian Process', 
                                       'Threshold', 'Hill', 'Power'))

```


### 14-day Smoothing Window

```{r}

### smoothing window 14 days
p1 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & alarmGen == 'thresh'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & alarmGen == 'thresh'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit) 

p2 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & alarmGen == 'hill'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & alarmGen == 'hill'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit)

p3 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & alarmGen == 'power'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & alarmGen == 'power'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit)


grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("14-day smoothing", gp = gpar(fontsize = 18, font = 1)))
```

### 30-day Smoothing Window


```{r}

p1 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & alarmGen == 'thresh'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & alarmGen == 'thresh'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit) 

p2 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & alarmGen == 'hill'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & alarmGen == 'hill'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit)

p3 <- ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & alarmGen == 'power'), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & alarmGen == 'power'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_wrap(~alarmFit) 

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("30-day smoothing", gp = gpar(fontsize = 18, font = 1)))

```



## Posterior prediction

Difficult to look at for every simulated epidemic. Shown here for first epidemic 
from each scenario.

```{r}

simNumber <- 1

# get true epidemic curves for each scenario
trueCurveThresh14 <- readRDS(paste0('./Data/thresh_fixed_14.rds'))[simNumber,]
trueCurveThresh30 <- readRDS(paste0('./Data/thresh_fixed_30.rds'))[simNumber,]
trueCurveHill14 <- readRDS(paste0('./Data/hill_fixed_14.rds'))[simNumber,]
trueCurveHill30 <- readRDS(paste0('./Data/hill_fixed_30.rds'))[simNumber,]
trueCurvePower14 <- readRDS(paste0('./Data/power_fixed_14.rds'))[simNumber,]
trueCurvePower30 <- readRDS(paste0('./Data/power_fixed_30.rds'))[simNumber,]

trueCurves <- data.frame(time = rep(1:length(trueCurveThresh14), 6),
                         truth = c(trueCurveThresh14, trueCurveThresh30,
                                   trueCurveHill14, trueCurveHill30,
                                   trueCurvePower14, trueCurvePower30),
                         alarmGen = c(rep('thresh', length(trueCurveThresh14)*2),
                                      rep('hill', length(trueCurveThresh14)*2),
                                      rep('power', length(trueCurveThresh14)*2)),
                         smoothWindow = rep(rep(c(14, 30), each = length(trueCurveThresh14)), 3))

# merge with posterior predictions
postPredAll <- readRDS('./resultsFinal/postPredAll.rds')
postPredAll <- postPredAll[postPredAll$simNumber == simNumber,]

```

### 14-day Smoothing Window

```{r}
p1 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p2 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p3 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 14),
               aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("14-day smoothing", gp = gpar(fontsize = 18, font = 1)))

```

### 30-day Smoothing Window

```{r}
p1 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p2 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p3 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 30),
               aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("30-day smoothing", gp = gpar(fontsize = 18, font = 1)))

```


Now for second simulated epidemic

```{r}

simNumber <- 2

# get true epidemic curves for each scenario
trueCurveThresh14 <- readRDS(paste0('./Data/thresh_fixed_14.rds'))[simNumber,]
trueCurveThresh30 <- readRDS(paste0('./Data/thresh_fixed_30.rds'))[simNumber,]
trueCurveHill14 <- readRDS(paste0('./Data/hill_fixed_14.rds'))[simNumber,]
trueCurveHill30 <- readRDS(paste0('./Data/hill_fixed_30.rds'))[simNumber,]
trueCurvePower14 <- readRDS(paste0('./Data/power_fixed_14.rds'))[simNumber,]
trueCurvePower30 <- readRDS(paste0('./Data/power_fixed_30.rds'))[simNumber,]

trueCurves <- data.frame(time = rep(1:length(trueCurveThresh14), 6),
                         truth = c(trueCurveThresh14, trueCurveThresh30,
                                   trueCurveHill14, trueCurveHill30,
                                   trueCurvePower14, trueCurvePower30),
                         alarmGen = c(rep('thresh', length(trueCurveThresh14)*2),
                                      rep('hill', length(trueCurveThresh14)*2),
                                      rep('power', length(trueCurveThresh14)*2)),
                         smoothWindow = rep(rep(c(14, 30), each = length(trueCurveThresh14)), 3))

# merge with posterior predictions
postPredAll <- readRDS('./resultsFinal/postPredAll.rds')
postPredAll <- postPredAll[postPredAll$simNumber == simNumber,]

```

### 14-day Smoothing Window

```{r}
p1 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p2 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p3 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 14),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 14),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 14),
               aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("14-day smoothing", gp = gpar(fontsize = 18, font = 1)))

```

### 30-day Smoothing Window

```{r}
p1 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p2 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30),
               aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

p3 <- ggplot() +
  geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 30),
            aes(x = time, y = truth)) + 
   geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 30),
            aes(x = time, y = mean), col = 'red', size = 1) + 
   geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 30),
               aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
  facet_wrap(~alarmFit, nrow = 1)

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("30-day smoothing", gp = gpar(fontsize = 18, font = 1)))

```


## Posterior for beta[t] when modeled explicitly





## WAIC comparisons







