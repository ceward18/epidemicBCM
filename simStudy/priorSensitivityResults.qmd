---
title: "Prior Sensitivity Results"
format: 
    html:
        code-fold: true
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 10, fig.height = 6)

library(openxlsx)
library(ggplot2)
library(grid)
library(gridExtra)
library(nimble)
library(plyr)
library(knitr)

# functions to calculate the alarms
source('./scripts/modelCodes.R')

theme_set(theme_bw() + 
              theme(strip.background = element_rect(fill = 'white'),
                    strip.text = element_text(size = 18),
                    axis.title = element_text(size = 18),
                    axis.text = element_text(size = 16),
                    legend.title = element_text(size = 18),
                    legend.text = element_text(size = 16)))


```

Comparing four priors for the rate paramteter describing the mean length of the infectious period.

-   Prior 1 - strong centered on truth
-   Prior 2 - strong but misspecified
-   Prior 3 - vague centered on truth
-   Prior 4 - vague and misspecified (typo in code - did not run)

Done in the simulation setting, where the true value is 1/7 = 0.1429

```{r}
pal <- c('black', 'orange', 'blue', 'magenta')

# strong centered on truth
bb <- 1350
aa <- 1/7*bb
curve(dgamma(x, aa, bb), col = pal[1], lwd = 2, cex.lab = 1.4, cex.axis = 1.2,
      from = 0, to = 0.8)

# strong but misspecified
bb <- 1500
aa <- 1/2*bb
curve(dgamma(x, aa, bb), add = T, col = pal[2], lwd = 2)

# vague centered on truth
bb <- 100
aa <- 1/7*bb
curve(dgamma(x, aa, bb), add = T, col = pal[3], lwd = 2)

# vague and misspecified
bb <- 100
aa <- 1/2*bb
curve(dgamma(x, aa, bb), add = T, col = pal[4], lwd = 2)

abline(v = 1/7, lty = 2)

legend('topright', paste0('Prior ', 1:4),
       col = pal, lwd = 2, cex = 1.4)
```


## Small vs. Large Epidemics

Epidemics were simulated in both "small" and "large" settings.

In the small setting, the population size was 1 million and epidemics typically 
peaked around 400-500 cases per day. In the small setting, the first 50 days 
were used for model fitting.

In the large setting, the population size was 9 million and epidemics typically 
peaked around 4000-5000 cases per day. In the large setting, all 100 days were used 
for model fitting.

```{r}
# for the first simulation
simNumber <- 1
infPeriodSpec <- 'exp'

nDays <- 100

# get true epidemic curves for each scenario
trueCurveThresh14 <- readRDS(paste0('./Data/thresh_', infPeriodSpec, '_14.rds'))[simNumber,1:nDays]
trueCurveThresh30 <- readRDS(paste0('./Data/thresh_', infPeriodSpec, '_30.rds'))[simNumber,1:nDays]
trueCurveHill14 <- readRDS(paste0('./Data/hill_', infPeriodSpec, '_14.rds'))[simNumber,1:nDays]
trueCurveHill30 <- readRDS(paste0('./Data/hill_', infPeriodSpec, '_30.rds'))[simNumber,1:nDays]
trueCurvePower14 <- readRDS(paste0('./Data/power_', infPeriodSpec, '_14.rds'))[simNumber,1:nDays]
trueCurvePower30 <- readRDS(paste0('./Data/power_', infPeriodSpec, '_30.rds'))[simNumber,1:nDays]
trueCurveThresh14_L <- readRDS(paste0('./Data/thresh_', infPeriodSpec, '_14_large.rds'))[simNumber,1:nDays]
trueCurveThresh30_L <- readRDS(paste0('./Data/thresh_', infPeriodSpec, '_30_large.rds'))[simNumber,1:nDays]
trueCurveHill14_L <- readRDS(paste0('./Data/hill_', infPeriodSpec, '_14_large.rds'))[simNumber,1:nDays]
trueCurveHill30_L <- readRDS(paste0('./Data/hill_', infPeriodSpec, '_30_large.rds'))[simNumber,1:nDays]
trueCurvePower14_L <- readRDS(paste0('./Data/power_', infPeriodSpec, '_14_large.rds'))[simNumber,1:nDays]
trueCurvePower30_L <- readRDS(paste0('./Data/power_', infPeriodSpec, '_30_large.rds'))[simNumber,1:nDays]

trueCurves <- data.frame(time = rep(1:length(trueCurveThresh14), 12),
                         truth = c(trueCurveThresh14, trueCurveThresh30,
                                   trueCurveHill14, trueCurveHill30,
                                   trueCurvePower14, trueCurvePower30,
                                   trueCurveThresh14_L, trueCurveThresh30_L,
                                   trueCurveHill14_L, trueCurveHill30_L,
                                   trueCurvePower14_L, trueCurvePower30_L),
                         alarmGen = rep(c(rep('thresh', length(trueCurveThresh14)*2),
                                          rep('hill', length(trueCurveThresh14)*2),
                                          rep('power', length(trueCurveThresh14)*2)), 2),
                         smoothWindow = rep(rep(rep(c(14, 30), each = length(trueCurveThresh14)), 3), 2),
                         epiSize = rep(c('small', 'large'), each = 600))

ggplot(subset(trueCurves, epiSize == 'small'), aes(x = time, y = truth)) +
    geom_line() + 
    facet_grid(alarmGen ~ smoothWindow) + 
    ggtitle('Small epidemics')

ggplot(subset(trueCurves, epiSize == 'large'), aes(x = time, y = truth)) +
    geom_line() + 
    facet_grid(alarmGen ~ smoothWindow) + 
    ggtitle('Large epidemics')
```




## Gelman Rubin

By smoothing used to inform alarm function in data generation and prior used. 50 simulated epidemics using hill, power, and threshold alarms.

```{r}
grAll <- readRDS('./resultsFinal/grAll.rds')

notConverge <- grAll[which(grAll$gr > 1.1),  ]
notConvergeModels <-  notConverge[!duplicated(notConverge[,-which(colnames(notConverge) %in% 
                                                                      c('gr', 'grUpper',
                                                                        'param'))]),
                                  c('alarmGen', 'alarmFit',
                                    'prior', 'smoothWindow', 'epiSize', 'simNumber')]

notConvergeModels$noConverge <- 1


# notConvergeModels$prior <- factor(notConvergeModels$prior, 
#                               labels=c('True/strong', 'Wrong/strong',
#                                        'True/vague'))


table(notConvergeModels$alarmGen, 
      notConvergeModels$alarmFit,
      notConvergeModels$smoothWindow,
      notConvergeModels$prior,
      notConvergeModels$epiSize)
```

## Gelman Rubin

```{r}
### load truth
paramsTruth <- read.xlsx('simParamsSummary.xlsx')
paramsTruth <- paramsTruth[paramsTruth$infPeriod == 'exp',]

### wide to long
paramsTruth <- reshape(paramsTruth, 
                       varying = c("beta", "delta", "H", "nu", "x0", "k", "rateI"), 
                       v.names = "truth",
                       timevar = "param", 
                       times = c("beta", "delta", "H", "nu", "x0", "k", "rateI"), 
                       new.row.names = 1:1000,
                       direction = "long")

paramsTruth <- paramsTruth[-which(is.na(paramsTruth$truth)),]
paramsTruth <- paramsTruth[order(paramsTruth$alarmGen, paramsTruth$smoothWindow, paramsTruth$param),]
paramsTruth <- paramsTruth[-which(colnames(paramsTruth) %in% c('id'))]

paramsPostAll <- readRDS('./resultsFinal/paramsPostAll.rds')

# merge with truth
paramsPostAll <- merge(paramsPostAll, paramsTruth, by = c('param', 'alarmGen',
                                                          'smoothWindow', 'epiSize'),
                       all.x = T)

paramsPostAll <- paramsPostAll[order(paramsPostAll$alarmGen, 
                                     paramsPostAll$smoothWindow,
                                     paramsPostAll$epiSize,
                                     paramsPostAll$prior,
                                     paramsPostAll$simNumber, 
                                     paramsPostAll$param),]

### remove those that did not converge (TEMPORARY)
paramsPostAll <- merge(paramsPostAll, notConvergeModels,
                       by = c('alarmGen', 'alarmFit', 'prior',
                              'smoothWindow', 'epiSize', 'simNumber'),
                       all.x = T)

paramsPostAll$noConverge[is.na(paramsPostAll$noConverge)] <- 0



paramsPostAll$param <- factor(paramsPostAll$param , 
                              levels = c('beta', 'delta', 'H', 'k', 
                                         'nu', 'x0', 'rateI'),
                              labels=c('beta', 'delta', 'H', 'k',
                                       'nu', 'x[0]', 'gamma'))
paramsPostAll <- paramsPostAll[which(!is.na(paramsPostAll$param)),]

paramsPostAll$smoothWindow <- factor(paramsPostAll$smoothWindow, 
                                     labels=c('14-day smoothing',
                                              '30-day smoothing'))


paramsPostAll$prior <- factor(paramsPostAll$prior, 
                              labels=c('True/strong', 'Wrong/strong',
                                       'True/vague', 'Wrong/vague'))
```

### Threshold Alarm

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'thresh' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'thresh' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'thresh' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'thresh' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

### Hill Alarm

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'hill' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'hill' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'hill' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'hill' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

### Power Alarm

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'power' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'power' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'power' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'power' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior, scales = 'free', 
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 
```

### Spline Alarm

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'spline' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'spline' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'spline' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'spline' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

### Gaussian Process Alarm

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'gp' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'gp' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'gp' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'gp' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

### No Behavioral Change

#### Small Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'basic' & 
                         smoothWindow == '14-day smoothing' &
                         epiSize == 'small' &  
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'basic' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'small' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

#### Large Epidemics

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'basic' & 
                         smoothWindow == '14-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'basic' & 
                         smoothWindow == '30-day smoothing' & 
                         epiSize == 'large' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

### Flexible $\beta_t$

```{r}
ggplot(data = subset(paramsPostAll, alarmFit == 'betatSpline' & 
                         smoothWindow == '14-day smoothing' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, param = label_parsed)) +
    labs(x = 'Simulation Number', y = '') 

ggplot(data = subset(paramsPostAll, alarmFit == 'betatSpline' & 
                         smoothWindow == '30-day smoothing' & 
                         noConverge == 0), 
       aes(x = simNumber, y = mean)) +
    geom_point() + 
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.9,
                  position = position_dodge(width = 0.9)) +
    geom_hline(aes(yintercept = truth), col = 'red', linetype = 2)  +
    facet_grid(param ~ prior + alarmGen, scales = 'free',
               labeller =  labeller(smoothWindow = label_value, 
                                    param = label_parsed)) +
    labs(x = 'Simulation Number', y = '')
```

## Alarm Estimation

```{r}
### get parameters for true alarms
paramsTruth <- read.xlsx('simParamsSummary.xlsx')
paramsTruth <- paramsTruth[paramsTruth$infPeriod == 'exp',]


### small
N <- 1e6

xAlarm <- 0:400
trueAlarmThresh14 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14 & 
                                             paramsTruth$epiSize == 'small')],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14 & 
                                             paramsTruth$epiSize == 'small')])
trueAlarmThresh30 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30 & 
                                             paramsTruth$epiSize == 'small')],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30 & 
                                             paramsTruth$epiSize == 'small')])
trueAlarmHill14 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'small')],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'small')],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'small')])
trueAlarmHill30 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'small')],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'small')],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'small')])
trueAlarmPower14 <- powerAlarm(xAlarm, N = N, 
                               k = paramsTruth$k[
                                   (paramsTruth$alarmGen == 'power' & 
                                        paramsTruth$smoothWindow == 14 & 
                                        paramsTruth$epiSize == 'small')])
trueAlarmPower30 <- powerAlarm(xAlarm, N = N, 
                               k = paramsTruth$k[
                                   (paramsTruth$alarmGen == 'power' & 
                                        paramsTruth$smoothWindow == 30 & 
                                        paramsTruth$epiSize == 'small')])

trueAlarmsSmall <- data.frame(xAlarm = rep(xAlarm, 6),
                              trueAlarm = c(trueAlarmThresh14,
                                            trueAlarmThresh30,
                                            trueAlarmHill14,
                                            trueAlarmHill30,
                                            trueAlarmPower14,
                                            trueAlarmPower30),
                              alarmGen = c(rep('thresh', length(xAlarm)*2),
                                           rep('hill', length(xAlarm)*2),
                                           rep('power', length(xAlarm)*2)),
                              smoothWindow = rep(rep(c(14, 30), 
                                                     each = length(xAlarm)), 3),
                              epiSize = 'small')


### large
N <- 9e6

xAlarm <- 0:5000
trueAlarmThresh14 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14 & 
                                             paramsTruth$epiSize == 'large')],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 14 & 
                                             paramsTruth$epiSize == 'large')])
trueAlarmThresh30 <- thresholdAlarm(xAlarm, N = N, 
                                    delta = paramsTruth$delta[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30 & 
                                             paramsTruth$epiSize == 'large')],
                                    H = paramsTruth$H[
                                        (paramsTruth$alarmGen == 'thresh' & 
                                             paramsTruth$smoothWindow == 30 & 
                                             paramsTruth$epiSize == 'large')])
trueAlarmHill14 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'large')],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'large')],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 14 & 
                                      paramsTruth$epiSize == 'large')])
trueAlarmHill30 <- hillAlarm(xAlarm, 
                             nu = paramsTruth$nu[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'large')],
                             x0 = paramsTruth$x0[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'large')],
                             delta = paramsTruth$delta[
                                 (paramsTruth$alarmGen == 'hill' & 
                                      paramsTruth$smoothWindow == 30 & 
                                      paramsTruth$epiSize == 'large')])
trueAlarmPower14 <- powerAlarm(xAlarm, N = N, 
                               k = paramsTruth$k[
                                   (paramsTruth$alarmGen == 'power' & 
                                        paramsTruth$smoothWindow == 14 & 
                                        paramsTruth$epiSize == 'large')])
trueAlarmPower30 <- powerAlarm(xAlarm, N = N, 
                               k = paramsTruth$k[
                                   (paramsTruth$alarmGen == 'power' & 
                                        paramsTruth$smoothWindow == 30 & 
                                        paramsTruth$epiSize == 'large')])

trueAlarmsLarge <- data.frame(xAlarm = rep(xAlarm, 6),
                              trueAlarm = c(trueAlarmThresh14,
                                            trueAlarmThresh30,
                                            trueAlarmHill14,
                                            trueAlarmHill30,
                                            trueAlarmPower14,
                                            trueAlarmPower30),
                              alarmGen = c(rep('thresh', length(xAlarm)*2),
                                           rep('hill', length(xAlarm)*2),
                                           rep('power', length(xAlarm)*2)),
                              smoothWindow = rep(rep(c(14, 30), 
                                                     each = length(xAlarm)), 3),
                              epiSize = 'large')


trueAlarms <- rbind.data.frame(trueAlarmsSmall, trueAlarmsLarge)

### load posterior estimates
alarmAll <- readRDS('./resultsFinal/alarmPostAll.rds')
alarmAll$infPeriod <- 'exp'

### remove those that did not converge (TEMPORARY)
alarmAll <- merge(alarmAll, notConvergeModels,
                  by = c('alarmGen', 'alarmFit',  'prior',
                         'smoothWindow', 'epiSize', 'simNumber'),
                  all.x = T)

alarmAll$noConverge[is.na(alarmAll$noConverge)] <- 0

# format for better plotting
alarmAll$alarmFit <- factor(alarmAll$alarmFit,
                            levels = c('spline', 'gp', 'thresh', 
                                       'hill', 'power'),
                            labels = c('Spline', 'Gaussian Process', 
                                       'Threshold', 'Hill', 'Power'))


alarmAll$prior <- factor(alarmAll$prior, 
                         labels=c('True/strong', 'Wrong/strong',
                                  'True/vague', 'Wrong/vague'))
```

### 14-day Smoothing Window

#### Threshold Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & 
                                alarmGen == 'thresh' & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & 
                                alarmGen == 'thresh'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 
```


#### Hill Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & 
                                alarmGen == 'hill' & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & 
                                alarmGen == 'hill'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 
```


#### Power Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 14  & 
                                alarmGen == 'power' & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 14 & 
                                alarmGen == 'power'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 

```

### 30-day Smoothing Window

#### Threshold Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & 
                                alarmGen == 'thresh'  & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & 
                                alarmGen == 'thresh'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 
```

#### Hill Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & 
                                alarmGen == 'hill' & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & 
                                alarmGen == 'hill'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 
```


#### Power Alarm

```{r}
ggplot() +  
    geom_line(data = subset(alarmAll, smoothWindow == 30  & 
                                alarmGen == 'power' & noConverge == 0), 
              aes(x = xAlarm, y = mean, group = simNumber), 
              col = adjustcolor('grey40', alpha = 0.5)) +
    geom_line(data = subset(trueAlarms, smoothWindow == 30 & 
                                alarmGen == 'power'), 
              aes(x = xAlarm, y = trueAlarm), col = 'red') +
    facet_grid(prior~alarmFit + epiSize, scales = 'free_x') 

```

## Posterior Prediction

```{r}
simNumber <- 1
nDays <- 100


# merge with posterior predictions
postPredAll <- readRDS('./resultsFinal/postPredAll.rds')
postPredAll <- postPredAll[postPredAll$simNumber == simNumber,]


### remove those that did not converge (TEMPORARY)
postPredAll <- merge(postPredAll, notConvergeModels,
                     by = c('alarmGen', 'alarmFit',  'prior',
                            'smoothWindow', 'epiSize', 'simNumber'),
                     all.x = T)

postPredAll$noConverge[is.na(postPredAll$noConverge)] <- 0


# format for better plotting
postPredAll$alarmFit <- factor(postPredAll$alarmFit,
                               levels = c('basic', 'spline', 'gp', 'thresh',
                                          'hill', 'power'),
                               labels = c('Basic', 'Spline', 'Gaussian Process', 
                                          'Threshold', 'Hill', 'Power'))

postPredAll$prior <- factor(postPredAll$prior, 
                            labels=c('True/strong', 'Wrong/strong',
                                     'True/vague'))
```

### 14-day Smoothing Window

```{r}
p1 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 14 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 14 &
                                noConverge == 0),
                aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

p2 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 14 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 14 &
                                noConverge == 0),
                aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

p3 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 14 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 14 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 14 &
                                noConverge == 0),
                aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("14-day smoothing", gp = gpar(fontsize = 18, font = 1)))
```

### 30-day Smoothing Window

```{r}
p1 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'thresh' & smoothWindow == 30 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'thresh' & smoothWindow == 30 &
                                noConverge == 0),
                aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

p2 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'hill' & smoothWindow == 30 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'hill' & smoothWindow == 30 &
                                noConverge == 0),
                aes(x = time, ymin=lower, ymax=upper), alpha=0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

p3 <- ggplot() +
    geom_line(data = subset(trueCurves, alarmGen == 'power' & smoothWindow == 30 & epiSize == 'small'),
              aes(x = time, y = truth)) + 
    geom_line(data = subset(postPredAll, alarmGen == 'power' & smoothWindow == 30 &
                                noConverge == 0),
              aes(x = time, y = mean), col = 'red', size = 1) + 
    geom_ribbon(data=subset(postPredAll, alarmGen == 'power' & smoothWindow == 30 &
                                noConverge == 0),
                aes(x = time, ymin = lower, ymax = upper), alpha = 0.3, fill = 'red') +
    facet_grid(prior~alarmFit, scales = 'free') 

grid.arrange(p1, p2, p3, nrow = 3,
             top=textGrob("30-day smoothing", gp = gpar(fontsize = 18, font = 1)))
```

