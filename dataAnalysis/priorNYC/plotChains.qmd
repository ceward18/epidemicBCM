---
title: "Not Converged Models"
format: 
    html:
        code-fold: true
        self-contained: true
editor: source
---

```{r}
library(ggplot2)
library(nimble)

plotParamChains <- function(chains, param) {
    ylims <- c(min(chains[[1]][,param],
                   chains[[2]][,param],
                   chains[[3]][,param]),
               max(chains[[1]][,param],
                   chains[[2]][,param],
                   chains[[3]][,param]))
    
    plot(chains[[1]][,param], type = 'l', ylim = ylims, main = param)
    lines(chains[[2]][,param], col = 'red')
    lines(chains[[3]][,param], col = 'blue')
}

plotAlarmChains <- function(chains) {
    yAlarm1 <- chains[[1]][,grep('yAlarm', colnames(chains[[1]]))]
    yAlarm2 <- chains[[2]][,grep('yAlarm', colnames(chains[[2]]))]
    yAlarm3 <- chains[[3]][,grep('yAlarm', colnames(chains[[3]]))]
    
    yAlarmPost <- cbind.data.frame(x = rep(1:ncol(yAlarm1), 3),
                                   chain = rep(1:3, each = ncol(yAlarm1)),
                                   mean = c(colMeans(yAlarm1),
                                            colMeans(yAlarm2),
                                            colMeans(yAlarm3)),
                                   lower = c(apply(yAlarm1, 2, quantile, probs = 0.025),
                                             apply(yAlarm2, 2, quantile, probs = 0.025),
                                             apply(yAlarm3, 2, quantile, probs = 0.025)),
                                   upper = c(apply(yAlarm1, 2, quantile, probs = 0.975),
                                             apply(yAlarm2, 2, quantile, probs = 0.975),
                                             apply(yAlarm3, 2, quantile, probs = 0.975)))
    
    yAlarmPost$chain <- factor(yAlarmPost$chain)
    
    ggplot(yAlarmPost, aes(x = x, y = mean,
                           ymin = lower, ymax = upper,
                           group = chain, col = chain, fill = chain)) +
        geom_line(size = 1) + 
        geom_ribbon(alpha = 0.2) +
        theme_bw() +
        ggtitle('Alarm function') + 
        scale_color_manual(values = c('black', 'red', 'blue')) + 
        scale_fill_manual(values = c('black', 'red', 'blue'))
    
}

```

## Models that didn't converge

```{r}
grAll <- readRDS('./resultsFinal/grAll.rds')
grAll <- grAll[grAll$infPeriod == 'exp',]

# which didn't converge
notConverge <- grAll[which(grAll$gr > 1.1),  ]
notConvergeModels <-  notConverge[
    !duplicated(notConverge
                [,-which(colnames(notConverge) %in% c('gr', 'grUpper', 'param'))]),
    c('alarmFit', 'infPeriod', 'smoothWindow', 'peak')]
notConvergeModels$noConverge <- 1


table(notConvergeModels$peak,
      notConvergeModels$smoothWindow,
      notConvergeModels$alarmFit)
```

## Threshold Models

Priors:

```{r}
#| code-fold: show


code <- nimbleCode({
    # priors
    beta ~ dgamma(0.1, 0.1)
    delta ~ dbeta(1, 1)
    H ~ dunif(minI/N, maxI/N)
    rateI ~ dgamma(aa, bb)
})
```

Samplers:

-   AF Slice: beta, delta
-   Slice: rateI
-   MH: H

```{r}
plotThreshChains <- function(chains) {
    
    par(mfrow = c(2,2))
    
    param <- 'beta'
    plotParamChains(chains, param)
    
    param <- 'delta'
    plotParamChains(chains, param)
    
    param <- 'H'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
    
}
```

### Peak 2

#### Prior 1

```{r}
chains <- readRDS('Output/chains_thresh_exp_peak2_60_1.rds')

plotThreshChains(chains)
plotAlarmChains(chains)
```

#### Prior 3
```{r}
chains <- readRDS('Output/chains_thresh_exp_peak2_60_3.rds')

plotThreshChains(chains)
plotAlarmChains(chains)
```

### Peak 4

#### Prior 2

```{r}
chains <- readRDS('Output/chains_thresh_exp_peak4_60_2.rds')

plotThreshChains(chains)
plotAlarmChains(chains)
```

#### Prior 3
```{r}
chains <- readRDS('Output/chains_thresh_exp_peak4_60_3.rds')

plotThreshChains(chains)
plotAlarmChains(chains)
```

## Hill

Priors:

```{r}
#| code-fold: show


code <- nimbleCode({
    # priors
    beta ~ dgamma(0.1, 0.1)
    delta ~ dbeta(1, 1)
    nu ~ dunif(0, 200)
    x0 ~ dunif(minI, maxI)
    rateI ~ dgamma(aa, bb)
})
```

Samplers:

-   AF Slice: beta, delta, nu, x0
-   Slice: rateI

```{r}
plotHillChains <- function(chains) {
    
    par(mfrow = c(2,3))
    
    param <- 'beta'
    plotParamChains(chains, param)
    
    param <- 'delta'
    plotParamChains(chains, param)
    
    param <- 'nu'
    plotParamChains(chains, param)
    
    param <- 'x0'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
}
```

### Peak 2

#### Prior 1

```{r}
chains <- readRDS('Output/chains_hill_exp_peak2_60_1.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### Prior 3

```{r}
chains <- readRDS('Output/chains_hill_exp_peak2_60_3.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### Prior 4

```{r}
chains <- readRDS('Output/chains_hill_exp_peak2_60_4.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

### Peak 4

#### Prior 1

```{r}
chains <- readRDS('Output/chains_hill_exp_peak4_60_1.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### Prior 3

```{r}
chains <- readRDS('Output/chains_hill_exp_peak4_60_3.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### Prior 4

```{r}
chains <- readRDS('Output/chains_hill_exp_peak4_60_4.rds')

plotHillChains(chains)
```

```{r}
plotAlarmChains(chains)
```

## Power

Priors:

```{r}
#| code-fold: show


code <- nimbleCode({
    # priors
    beta ~ dgamma(0.1, 0.1)
    k ~ dgamma(0.1, 0.1)
    rateI ~ dgamma(aa, bb)
})
```

Samplers:

-   AF Slice: beta, k
-   Slice: rateI

```{r}
plotPowerChains <- function(chains) {
    
    par(mfrow = c(1,3))
    
    param <- 'beta'
    plotParamChains(chains, param)
    
    param <- 'k'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
}
```

### Peak 4

#### Prior 4

```{r}
chains <- readRDS('Output/chains_power_exp_peak4_60_4.rds')

plotPowerChains(chains)
plotAlarmChains(chains)
```

## Gaussian Process

Priors:

```{r}
#| code-fold: show


code <- nimbleCode({
  # priors
  beta ~ dgamma(0.1, 0.1)
  sigma ~ dgamma(100, 50)
  l ~ dinvgamma(c, d)
  rateI ~ dgamma(aa, bb)
})
```

Samplers:

-   Slice: l
-   Slice: sigma
-   Slice: beta
-   Slice: rateI

```{r}
plotGPChains <- function(chains) {
    
    par(mfrow = c(2,2))
    
    param <- 'beta'
    plotParamChains(chains, param)
    
    param <- 'l'
    plotParamChains(chains, param)
    
    param <- 'sigma'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
}
```

### Peak 3

#### 15-day smoothing

```{r}
chains <- readRDS('Output/chains_gp_exp_peak1_60_1.rds')

plotGPChains(chains)
plotAlarmChains(chains)
```

#### 30-day smoothing

```{r}
chains <- readRDS('Output/chains_gp_exp_peak3_30.rds')

plotGPChains(chains)
plotAlarmChains(chains)
```

### Peak 4

#### 15-day smoothing

```{r}
chains <- readRDS('Output/chains_gp_exp_peak4_15.rds')

plotGPChains(chains)
plotAlarmChains(chains)
```

#### 45-day smoothing

```{r}
chains <- readRDS('Output/chains_gp_exp_peak4_45.rds')

plotGPChains(chains)
plotAlarmChains(chains)
```

#### 60-day smoothing

```{r}
chains <- readRDS('Output/chains_gp_exp_peak4_60.rds')

plotGPChains(chains)
plotAlarmChains(chains)
```

## Spline

Priors:

```{r}
#| code-fold: show

code <- nimbleCode({
  # priors
  beta ~ dgamma(0.1, 0.1)
  for (i in 1:nb) {
    b[i] ~ dnorm(0, sd = 100)
  }
  for (i in 1:(nb - 1)) {
    knots[i] ~ dunif(min = minI, max = maxI)
  }
  rateI ~ dgamma(aa, bb)
})
```

Samplers:

-   AF Slice: b's
-   AF Slice: knots'
-   AF slice: beta, rateI

```{r}
plotSplineChains <- function(chains) {
    
    par(mfrow = c(2,4))
    
    param <- 'beta'
    plotParamChains(chains, param)
    
    param <- 'b[1]'
    plotParamChains(chains, param)
    
    param <- 'b[2]'
    plotParamChains(chains, param)
    
    param <- 'b[3]'
    plotParamChains(chains, param)
    
    param <- 'knots[1]'
    plotParamChains(chains, param)
    
    param <- 'knots[2]'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
}
```

### Peak 2

#### 15-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak2_15.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### 30-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak2_30.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### 45-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak2_45.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

### Peak 4

#### 30-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak4_30.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### 45-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak4_45.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

#### 60-day smoothing

```{r}
chains <- readRDS('Output/chains_spline_exp_peak4_60.rds')

plotSplineChains(chains)
```

```{r}
plotAlarmChains(chains)
```

## Beta\[t\]

Priors:

```{r}
#| code-fold: show

code <- nimbleCode({
   # priors
  for (i in 1:nb) {
    b[i] ~ dnorm(0, sd = 100)
  }
  for (i in 1:(nb - 1)) {
    knots[i] ~ dunif(min = 1, max = tau)
  }
  rateI ~ dgamma(aa, bb)
  
})
```

Samplers:

-   RW sampler: b's
-   RW sampler: knots'
-   Slice: rateI

```{r}
plotBetatChains <- function(chains) {
    
    par(mfrow = c(2,4))
    
    param <- 'b[1]'
    plotParamChains(chains, param)
    
    param <- 'b[2]'
    plotParamChains(chains, param)
    
    param <- 'b[3]'
    plotParamChains(chains, param)
    
    param <- 'b[4]'
    plotParamChains(chains, param)
    
    param <- 'knots[1]'
    plotParamChains(chains, param)
    
    param <- 'knots[2]'
    plotParamChains(chains, param)
    
    param <- 'knots[3]'
    plotParamChains(chains, param)
    
    param <- 'rateI'
    plotParamChains(chains, param)
    
}


plotBetaChains <- function(chains) {
    yAlarm1 <- chains[[1]][,grep('beta', colnames(chains[[1]]))]
    yAlarm2 <- chains[[2]][,grep('beta', colnames(chains[[2]]))]
    yAlarm3 <- chains[[3]][,grep('beta', colnames(chains[[3]]))]
    
    yAlarmPost <- cbind.data.frame(x = rep(1:ncol(yAlarm1), 3),
                                   chain = rep(1:3, each = ncol(yAlarm1)),
                                   mean = c(colMeans(yAlarm1),
                                            colMeans(yAlarm2),
                                            colMeans(yAlarm3)),
                                   lower = c(apply(yAlarm1, 2, quantile, probs = 0.025),
                                             apply(yAlarm2, 2, quantile, probs = 0.025),
                                             apply(yAlarm3, 2, quantile, probs = 0.025)),
                                   upper = c(apply(yAlarm1, 2, quantile, probs = 0.975),
                                             apply(yAlarm2, 2, quantile, probs = 0.975),
                                             apply(yAlarm3, 2, quantile, probs = 0.975)))
    
    yAlarmPost$chain <- factor(yAlarmPost$chain)
    
    ggplot(yAlarmPost, aes(x = x, y = mean,
                           ymin = lower, ymax = upper,
                           group = chain, col = chain, fill = chain)) +
        geom_line(size = 1) + 
        geom_ribbon(alpha = 0.2) +
        theme_bw() +
        ggtitle('Beta[t] function') +
        scale_color_manual(values = c('black', 'red', 'blue')) + 
        scale_fill_manual(values = c('black', 'red', 'blue'))
    
}
```

### Peak 1

```{r}
chains <- readRDS('Output/chains_betatSpline_exp_peak1_1.rds')

plotBetatChains(chains)
plotBetaChains(chains)
```

### Peak 4

```{r}
chains <- readRDS('Output/chains_betatSpline_exp_peak4_1.rds')

plotBetatChains(chains)
plotBetaChains(chains)
```
